### Setup ec2.py and ec2.ini files in each inventory directory
---
- debug:
    var: aws_inventory_environments
    verbosity: 1

- name: Copy the ec2.py file into playbook_dir/inventory directory
  copy:
    src: '{{ role_path }}/files/ec2.py'
    dest: '{{ playbook_dir }}/inventory/ec2.py'
    mode: u=rwx,g=r,o=r

- name: Ensure inventory directories exists
  file:
    path: '{{ playbook_dir }}/inventory/{{ item }}'
    state: directory
  with_items: '{{ aws_inventory_environments }}'

- name: Softlink the ec2.py file into each environment
  file:
    src: '../ec2.py'
    dest: '{{ playbook_dir }}/inventory/{{ item }}/ec2.py'
    state: link
  with_items: '{{ aws_inventory_environments }}'

- name: Template an ec2.ini for each environment
  template:
    src: ec2.ini.j2
    dest: '{{ playbook_dir }}/inventory/{{ item }}/ec2.ini'
  with_items: '{{ aws_inventory_environments }}'
